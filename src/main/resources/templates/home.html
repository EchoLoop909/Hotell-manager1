<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trang chủ</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
</head>
<body>
<!-- Gọi navbar fragment -->
<th:block th:replace="~{fragments/navbar :: navbar}"></th:block>

<!-- Nội dung trang chủ -->
<div class="container">
    <h2>Chào mừng <span id="user-name">Người dùng</span> đến với hệ thống quản lý khách sạn!</h2>
    <p>Hệ thống giúp bạn quản lý đặt phòng, khách hàng và dịch vụ một cách dễ dàng và hiệu quả.</p>

    <div style="margin-top: 30px;">
        <!-- Các nút chuyển hướng -->
        <a href="/bookings"><button>Quản lý đặt phòng</button></a>
        <a href="/customers" id="manage-customers" style="display: none;"><button>Quản lý khách hàng</button></a>
        <a href="/employee" id="manage-employees" style="display: none;"><button>Quản lý nhân viên</button></a>
    </div>
</div>

<script>
    async function refreshToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) {
            localStorage.clear();
            window.location.href = '/login';
            return false;
        }

        try {
            const response = await fetch('/api/v1/auth/refresh-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ refreshToken })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.accessToken);
                localStorage.setItem('refreshToken', data.refreshToken);
                localStorage.setItem('user', JSON.stringify({ name: data.name, role: data.role }));
                return true;
            } else {
                throw new Error('Invalid refresh token');
            }
        } catch (error) {
            console.error('Refresh token error:', error);
            localStorage.clear();
            window.location.href = '/login';
            return false;
        }
    }

    async function checkAuth() {
        const user = JSON.parse(localStorage.getItem('user'));
        const accessToken = localStorage.getItem('accessToken');

        if (!user || !accessToken) {
            localStorage.clear();
            window.location.href = '/login';
            return;
        }

        // Hiển thị tên người dùng
        document.getElementById('user-name').textContent = user.name;

        // Hiển thị nút quản lý dựa trên vai trò
        if (user.role === 'lễ_tân' || user.role === 'quản_lý') {
            document.getElementById('manage-customers').style.display = 'inline-block';
            document.getElementById('manage-employees').style.display = 'inline-block';
        }

        // Kiểm tra access token bằng cách gọi một API bảo vệ
        try {
            const response = await fetch('/api/v1/customers', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            if (response.status === 401) {
                // Access token hết hạn, thử làm mới
                const refreshed = await refreshToken();
                if (!refreshed) return;
                // Thử lại API với token mới
                const newToken = localStorage.getItem('accessToken');
                await fetch('/api/v1/customers', {
                    headers: {
                        'Authorization': `Bearer ${newToken}`
                    }
                });
            }
        } catch (error) {
            console.error('Auth check error:', error);
            localStorage.clear();
            window.location.href = '/login';
        }
    }

    window.onload = checkAuth;

    function showNotification(message, isError = false) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.style.backgroundColor = isError ? "#f44336" : "#4caf50";
        notification.style.color = "#fff";
        notification.style.display = "block";
        setTimeout(() => {
            notification.style.display = "none";
        }, 3000);
    }

    async function logout() {
        const refreshToken = localStorage.getItem('refreshToken');

        if (!refreshToken) {
            showNotification("Không tìm thấy refresh token", true);
            localStorage.clear();
            setTimeout(() => window.location.href = '/login', 1000);
            return;
        }

        console.log('Attempting logout with refreshToken:', refreshToken);

        try {
            const response = await fetch('/api/v1/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refreshToken })
            });

            const responseData = await response.json();
            console.log('Logout response:', responseData);

            if (response.ok && responseData.success) {
                showNotification("Đăng xuất thành công123", false);
                localStorage.clear();
                setTimeout(() => window.location.href = '/login', 1000);
            } else {
                showNotification(responseData.message || "Đăng xuất thất bại", true);
                console.error('Logout failed with message:', responseData.message);
            }
        } catch (error) {
            showNotification("Lỗi kết nối máy chủ", true);
            console.error('Logout error:', error);
        }
    }
</script>
</body>
</html>