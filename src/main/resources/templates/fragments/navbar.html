<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<th:block th:fragment="navbar">
    <div class="navbar">
        <a href="/home">Trang chủ</a>
        <a href="/bookings">Đặt phòng</a>
        <a href="/customers" id="nav-customers" style="display: none;">Khách hàng</a>
        <a href="/employee" id="nav-employees" style="display: none;">Nhân viên</a>
        <a href="/login" class="logout" onclick="logout()">Đăng xuất</a>
    </div>
    <div id="notification"></div>
</th:block>
<script>
    async function refreshToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) {
            localStorage.clear();
            window.location.href = '/login';
            return null;
        }
        try {
            const response = await fetch('/api/v1/auth/refresh-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken })
            });
            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.accessToken);
                localStorage.setItem('refreshToken', data.refreshToken);
                localStorage.setItem('user', JSON.stringify({ name: data.name, role: data.role }));
                return data.accessToken;
            }
            throw new Error('Invalid refresh token');
        } catch (error) {
            console.error('Refresh token error:', error);
            localStorage.clear();
            window.location.href = '/login';
            return null;
        }
    }

    async function logout() {
        event.preventDefault();
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) {
            showNotification("Không tìm thấy refresh token", true);
            localStorage.clear();
            setTimeout(() => window.location.href = '/login', 1000);
            return;
        }
        try {
            const response = await fetch('/api/v1/auth/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken })
            });
            const responseData = await response.json();
            if (response.ok) {
                showNotification("Đăng xuất thành công", false);
                localStorage.clear();
                setTimeout(() => window.location.href = '/login', 1000);
            } else {
                showNotification(responseData.message || "Đăng xuất thất bại", true);
            }
        } catch (error) {
            showNotification("Lỗi kết nối máy chủ", true);
            console.error('Logout error:', error);
        }
    }

    function showNotification(message, isError = false) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.style.backgroundColor = isError ? "#f44336" : "#4caf50";
        notification.style.color = "#fff";
        notification.style.display = "block";
        setTimeout(() => notification.style.display = "none", 3000);
    }

    const user = JSON.parse(localStorage.getItem('user'));
    if (user) {
        document.getElementById('nav-customers').style.display = 'inline-block';
        if (user.role === 'QUAN_LY') {
            document.getElementById('nav-employees').style.display = 'inline-block';
        }
    }
</script>
</body>
</html>