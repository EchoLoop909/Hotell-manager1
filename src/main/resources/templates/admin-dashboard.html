<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<!-- Gọi navbar từ fragment -->
<th:block th:replace="fragments/navbar-login :: navbar"></th:block>

<!-- Nội dung chính -->
<div class="container">
  <h2>Chào mừng <span id="admin-name">Quản trị viên</span> đến với trang quản lý admin!</h2>
  <div id="notification" style="display: none; padding: 10px; margin: 10px; border-radius: 5px; position: fixed; top: 10px; right: 10px;"></div>
  <p>Trang này dành riêng cho các quản trị viên của hệ thống.</p>

  <!-- Các chức năng quản lý dành cho admin -->
  <div style="margin-top: 30px;">
    <a href="/manage-users"><button>Quản lý khách hàng</button></a>
    <a href="/manage-rooms"><button>Quản lý phòng</button></a>
    <a href="/manage-services"><button>Quản lý dịch vụ</button></a>
    <a href="/manage-employee"><button>Quản lý nhân viên</button></a>
    <a href="#" onclick="logout(event)"><button>Đăng xuất</button></a>
  </div>
</div>

<!-- Kiểm tra người dùng -->
<script>
  window.onload = function () {
    const user = JSON.parse(localStorage.getItem('user'));
    if (user) {
      document.getElementById('admin-name').textContent = user.firstname;
      if (user.role !== 'ADMIN') {
        window.location.href = '/home';
      }
    } else {
      window.location.href = '/login';
    }
  }

  function showNotification(message, isError = false) {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.style.backgroundColor = isError ? "#f44336" : "#4caf50";
    notification.style.color = "#fff";
    notification.style.display = "block";
    setTimeout(() => {
      notification.style.display = "none";
    }, 3000);
  }

  function clearLocalStorageAndRedirect() {
    localStorage.removeItem("accessToken");
    localStorage.removeItem("refreshToken");
    localStorage.removeItem("user");=
    setTimeout(() => {
      window.location.href = "/login";
    }, 1000);
  }

  function logout(event) {
    event.preventDefault();

    const refreshToken = localStorage.getItem("refreshToken");

    if (!refreshToken || refreshToken.trim() === "") {
      showNotification("Phiên đăng nhập đã hết hạn hoặc không hợp lệ.", true);
      clearLocalStorageAndRedirect();
      return;
    }

    fetch("/api/v1/auth/logout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refreshToken })
    })
            .then(async res => {
              const data = await res.json();
              if (!res.ok) {
                throw new Error(data.message || "Lỗi không xác định");
              }
              return data;
            })
            .then(data => {
              showNotification(data.message || "Đăng xuất thành công", false);
              clearLocalStorageAndRedirect();
            })
            .catch(err => {
              showNotification("Lỗi khi đăng xuất: " + err.message, true);
              clearLocalStorageAndRedirect();
            });
  }
</script>

</body>
</html>